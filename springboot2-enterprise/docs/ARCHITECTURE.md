# 架构设计文档

## 系统架构图

```
┌─────────────────────────────────────────────────────────────┐
│                         用户/客户端                          │
└───────────────────────┬─────────────────────────────────────┘
                        │
                        ▼
┌─────────────────────────────────────────────────────────────┐
│                   API Gateway (9527)                        │
│  - 路由转发                                                  │
│  - 负载均衡                                                  │
│  - 统一鉴权                                                  │
│  - 限流熔断                                                  │
└───────────────┬───────────────┬─────────────────────────────┘
                │               │
        ┌───────┴─────┐    ┌────┴──────┐
        │             │    │           │
        ▼             ▼    ▼           ▼
┌──────────────┐ ┌─────────────┐ ┌──────────────┐
│ Auth Service │ │   System    │ │   Other      │
│   (9200)     │ │   Service   │ │   Services   │
│              │ │   (9201)    │ │              │
│ - 用户认证    │ │ - 用户管理   │ │ - 业务模块    │
│ - JWT签发    │ │ - 角色管理   │ │              │
│ - 权限验证    │ │ - 菜单管理   │ │              │
└──────┬───────┘ └──────┬──────┘ └──────┬───────┘
       │                │               │
       └────────┬───────┴───────┬───────┘
                │               │
        ┌───────┴───────┬───────┴────────┐
        │               │                │
        ▼               ▼                ▼
┌──────────────┐ ┌─────────────┐ ┌──────────────┐
│    Nacos     │ │    Redis    │ │    MySQL     │
│   (8848)     │ │   (6379)    │ │   (3306)     │
│              │ │             │ │              │
│ - 服务注册    │ │ - 缓存      │ │ - 数据存储    │
│ - 配置中心    │ │ - Session   │ │              │
└──────────────┘ └─────────────┘ └──────────────┘
        │
        ▼
┌──────────────────────────────────────────────────┐
│              中间件层                             │
│                                                  │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐      │
│  │ RabbitMQ │  │  Seata   │  │   ELK    │      │
│  │  (5672)  │  │  (8091)  │  │  (9200)  │      │
│  │          │  │          │  │          │      │
│  │ 消息队列  │  │ 分布式    │  │ 日志分析  │      │
│  │          │  │ 事务      │  │          │      │
│  └──────────┘  └──────────┘  └──────────┘      │
└──────────────────────────────────────────────────┘
```

## 技术栈层次

```
┌──────────────────────────────────────┐
│         展示层 (Presentation)         │
│  - RESTful API                       │
│  - Swagger/Knife4j                   │
└──────────────────────────────────────┘
                 ▼
┌──────────────────────────────────────┐
│          业务层 (Business)            │
│  - Spring MVC                        │
│  - Spring Security                   │
│  - 业务逻辑处理                        │
└──────────────────────────────────────┘
                 ▼
┌──────────────────────────────────────┐
│          服务层 (Service)             │
│  - Spring Cloud                      │
│  - Nacos Discovery                   │
│  - OpenFeign                         │
└──────────────────────────────────────┘
                 ▼
┌──────────────────────────────────────┐
│         数据层 (Persistence)          │
│  - MyBatis Plus                      │
│  - Druid                             │
│  - MySQL                             │
└──────────────────────────────────────┘
```

## 模块依赖关系

```
enterprise-gateway
    ├── common-core
    └── common-redis

enterprise-auth
    ├── common-core
    ├── common-redis
    ├── common-security
    └── common-swagger

enterprise-system
    ├── common-core
    ├── common-redis
    ├── common-mybatis
    ├── common-security
    └── common-swagger

common-security
    ├── common-core
    └── common-redis

common-mybatis
    └── common-core

common-log
    └── common-core

common-swagger
    (无依赖)

common-redis
    (无依赖)

common-core
    (无依赖)
```

## 数据流转

### 1. 用户认证流程

```
┌──────┐    ┌─────────┐    ┌──────────┐    ┌───────┐
│ 客户端 │───▶│ Gateway │───▶│   Auth   │───▶│ Redis │
└──────┘    └─────────┘    │ Service  │    └───────┘
              ▲             └──────────┘         │
              │                   │              │
              │                   ▼              │
              │             ┌──────────┐         │
              └─────────────│   JWT    │◀────────┘
                            │  Token   │
                            └──────────┘
```

**步骤说明：**
1. 客户端发送用户名密码到网关
2. 网关转发到认证服务
3. 认证服务验证用户信息
4. 生成 JWT Token
5. 将 Token 存入 Redis（可选）
6. 返回 Token 给客户端

### 2. 业务请求流程

```
┌──────┐    ┌─────────┐    ┌──────────┐    ┌───────┐
│ 客户端 │───▶│ Gateway │───▶│  System  │───▶│ MySQL │
│      │    │         │    │ Service  │    └───────┘
│ +JWT │    │ JWT验证  │    └──────────┘         ▲
└──────┘    └─────────┘           │              │
                 │                ▼              │
                 │          ┌──────────┐         │
                 │          │  Redis   │         │
                 │          │  Cache   │         │
                 │          └──────────┘         │
                 │                │              │
                 └────────────────┴──────────────┘
```

**步骤说明：**
1. 客户端携带 JWT Token 发起请求
2. 网关验证 Token 有效性
3. 转发到对应的业务服务
4. 业务服务先查询缓存
5. 缓存未命中则查询数据库
6. 更新缓存并返回结果

### 3. 分布式事务流程

```
┌──────────┐     ┌──────────┐     ┌──────────┐
│  Order   │────▶│  Stock   │────▶│ Account  │
│ Service  │     │ Service  │     │ Service  │
└────┬─────┘     └────┬─────┘     └────┬─────┘
     │                │                │
     │                │                │
     ▼                ▼                ▼
┌─────────────────────────────────────────┐
│          Seata Transaction              │
│  ┌──────┐  ┌──────┐  ┌──────┐          │
│  │ TM   │─▶│ TC   │◀─│ RM   │          │
│  └──────┘  └──────┘  └──────┘          │
└─────────────────────────────────────────┘
```

**说明：**
- TM (Transaction Manager): 事务管理器
- TC (Transaction Coordinator): 事务协调器
- RM (Resource Manager): 资源管理器

## 核心组件设计

### 1. 统一响应封装

```java
public class R<T> {
    private int code;      // 状态码
    private String msg;    // 消息
    private T data;        // 数据
    private long timestamp; // 时间戳
}
```

### 2. 分页查询封装

```java
public class PageQuery {
    private Integer pageNum;  // 页码
    private Integer pageSize; // 每页大小
    private String orderBy;   // 排序字段
    private String sort;      // 排序方向
}

public class PageResult<T> {
    private Long total;       // 总记录数
    private List<T> records;  // 数据列表
    private Integer pages;    // 总页数
    private Integer current;  // 当前页
}
```

### 3. 实体基类

```java
public class BaseEntity {
    private LocalDateTime createTime; // 创建时间
    private String createBy;          // 创建人
    private LocalDateTime updateTime; // 更新时间
    private String updateBy;          // 更新人
    private String remark;            // 备注
}
```

## 安全架构

### 1. 认证授权流程

```
1. 用户登录
   ↓
2. 验证用户名密码
   ↓
3. 生成 JWT Token
   ↓
4. Token 包含用户信息和权限
   ↓
5. 客户端携带 Token 访问
   ↓
6. Gateway 验证 Token
   ↓
7. 解析用户权限
   ↓
8. 放行或拒绝请求
```

### 2. 权限模型（RBAC）

```
User (用户)
  ├── UserRole (用户角色关联)
  │     └── Role (角色)
  │           ├── RoleMenu (角色菜单关联)
  │           │     └── Menu (菜单/权限)
  │           └── Permissions (权限标识)
  └── Permissions (最终权限集合)
```

## 缓存策略

### 1. 多级缓存

```
┌────────────┐
│   请求      │
└─────┬──────┘
      │
      ▼
┌────────────┐    命中    ┌────────────┐
│ 本地缓存    │───────────▶│   返回      │
│ (Caffeine) │            └────────────┘
└─────┬──────┘
      │ 未命中
      ▼
┌────────────┐    命中    ┌────────────┐
│ Redis缓存  │───────────▶│   返回      │
└─────┬──────┘            └────────────┘
      │ 未命中
      ▼
┌────────────┐
│   数据库    │
└─────┬──────┘
      │
      ▼
┌────────────┐
│  更新缓存   │
└────────────┘
```

### 2. 缓存更新策略

- **Cache Aside**: 先更新数据库，再删除缓存
- **Read Through**: 缓存自动加载数据
- **Write Through**: 同步更新缓存和数据库
- **Write Behind**: 异步更新数据库

## 监控体系

```
┌──────────────────────────────────────┐
│         应用层监控                    │
│  - Spring Boot Actuator              │
│  - Micrometer                        │
└──────────────────────────────────────┘
                 ▼
┌──────────────────────────────────────┐
│         中间件监控                    │
│  - MySQL Performance Schema          │
│  - Redis Monitor                     │
│  - RabbitMQ Management               │
└──────────────────────────────────────┘
                 ▼
┌──────────────────────────────────────┐
│         日志监控                      │
│  - ELK Stack                         │
│  - Filebeat                          │
│  - Logstash                          │
└──────────────────────────────────────┘
                 ▼
┌──────────────────────────────────────┐
│         可视化展示                    │
│  - Kibana Dashboard                  │
│  - Grafana                           │
└──────────────────────────────────────┘
```

## 性能优化

### 1. 数据库优化
- 合理使用索引
- 分页查询
- 读写分离
- 分库分表

### 2. 缓存优化
- 热点数据缓存
- 缓存预热
- 缓存降级
- 防止缓存穿透、击穿、雪崩

### 3. 接口优化
- 异步处理
- 批量操作
- 接口限流
- 数据压缩

## 高可用设计

### 1. 服务高可用
- 多实例部署
- 负载均衡
- 健康检查
- 自动重启

### 2. 数据高可用
- MySQL 主从复制
- Redis 哨兵/集群
- 定期备份
- 容灾恢复

### 3. 容错机制
- 服务降级
- 熔断保护
- 限流控制
- 超时重试

---

**最后更新**: 2025-11-20
